name: Deploy Full Stack to Windows Desktop

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: wsl -u root {0}

    steps:
      - name: 코드 내려받기 (Checkout)
        uses: actions/checkout@v3

      # --------------------------------------------------------
      # -------------------------------------------------------
      - name: Create .env files inside WSL
        run: |
          # 루트 .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" > .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> .env
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
          echo "BACKEND_PORT=${{ secrets.PORT }}" >> .env
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env
          echo "TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env

          # 백엔드 .env
          echo "PORT=${{ secrets.PORT }}" > backend-api/.env
          echo "NODE_ENV=production" >> backend-api/.env
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> backend-api/.env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> backend-api/.env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> backend-api/.env
          echo "DB_USER=${{ secrets.DB_USER }}" >> backend-api/.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> backend-api/.env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> backend-api/.env
          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> backend-api/.env
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> backend-api/.env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> backend-api/.env

          # 프론트엔드 .env
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > frontend-web/.env.local

          # 그림 엔진 .env
          echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}" > drawing-engine/.env
          echo "BACKEND_API_PATH=/app/backend-api" >> drawing-engine/.env
          echo "TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}" >> drawing-engine/.env

      # --------------------------------------------------------
      # --------------------------------------------------------
      - name: Run Docker Compose
        # docker-compose는 윈도우 실행파일(.exe)을 호출해야 경로 문제가 덜 생깁니다.
        shell: cmd
        run: |
          docker-compose down --remove-orphans
          docker-compose up -d --build