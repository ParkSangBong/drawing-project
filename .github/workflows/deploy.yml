name: Deploy Full Stack to Windows Desktop

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: 코드 내려받기 (Checkout)
        uses: actions/checkout@v3

      - name: Create Root .env
        run: |
          $content = @"
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          BACKEND_PORT=${{ secrets.PORT }}
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          Set-Content -Path ".env" -Value $content -Encoding UTF8

      - name: Create Backend .env
        run: |
          $content = @"
          PORT=${{ secrets.PORT }}
          NODE_ENV=production
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          Set-Content -Path "backend-api/.env" -Value $content -Encoding UTF8

      - name: Create Frontend .env
        run: |
          $content = @"
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          "@
          Set-Content -Path "frontend-web/.env.local" -Value $content -Encoding UTF8

      - name: Create Engine .env
        run: |
          $content = @"
          REDIS_URL=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}
          BACKEND_API_PATH=/app/backend-api
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          "@
          Set-Content -Path "drawing-engine/.env" -Value $content -Encoding UTF8

      - name: Run Docker Compose via WSL
        run: |
          # 윈도우 PowerShell에서 'wsl' 명령어를 통해 리눅스에게 작업을 시킵니다.
          # 이렇게 하면 경로 꼬임 문제 없이 WSL 환경을 그대로 쓸 수 있습니다.
          
          Write-Host "Shutting down existing containers via WSL..."
          wsl docker-compose down --remove-orphans
          
          Write-Host "Building and starting containers via WSL..."
          wsl docker-compose up -d --build