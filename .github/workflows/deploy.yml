name: Deploy Full Stack to Windows Desktop

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: 코드 내려받기 (Checkout)
        uses: actions/checkout@v3

      - name: Create Root .env
        run: |
          $content = @"
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          BACKEND_PORT=${{ secrets.PORT }}
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          
          # [중요] BOM(서명) 없는 UTF-8로 강제 저장하는 .NET 명령어입니다.
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText(".env", $content, $enc)

      - name: Create Backend .env
        run: |
          $content = @"
          PORT=${{ secrets.PORT }}
          NODE_ENV=production
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("backend-api/.env", $content, $enc)

      - name: Create Frontend .env
        run: |
          $content = @"
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("frontend-web/.env.local", $content, $enc)

      - name: Create Engine .env
        run: |
          $content = @"
          REDIS_URL=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}
          BACKEND_API_PATH=/app/backend-api
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("drawing-engine/.env", $content, $enc)

      - name: Run Docker Compose via WSL
        run: |
          Write-Host "Shutting down existing containers via WSL..."
          wsl docker-compose down --remove-orphans
          
          Write-Host "Building and starting containers via WSL..."
          wsl docker-compose up -d --build