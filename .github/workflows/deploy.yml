name: Deploy Full Stack to Windows Desktop

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    steps:
      - name: ì½”ë“œ ë‚´ë ¤ë°›ê¸° (Checkout)
        uses: actions/checkout@v3

      # ----------------------------------------------------------------
      # [1] í™˜ê²½ ë³€ìˆ˜ ìƒì„± ë‹¨ê³„ (ê¸°ì¡´ ë¡œì§ 100% ìœ ì§€)
      # ----------------------------------------------------------------
      - name: Create Root .env
        run: |
          $content = @"
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          BACKEND_PORT=${{ secrets.PORT }}
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText(".env", $content, $enc)

      - name: Create Backend .env
        run: |
          $content = @"
          PORT=${{ secrets.PORT }}
          NODE_ENV=production
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("backend-api/.env", $content, $enc)

      - name: Create Frontend .env
        run: |
          $content = @"
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("frontend-web/.env.local", $content, $enc)

      - name: Create Engine .env
        run: |
          $content = @"
          REDIS_URL=redis://${{ secrets.REDIS_HOST }}:${{ secrets.REDIS_PORT }}
          BACKEND_API_PATH=/app/backend-api
          TESSERACT_PATH=${{ secrets.TESSERACT_PATH }}
          "@
          
          $enc = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("drawing-engine/.env", $content, $enc)

      # ----------------------------------------------------------------
      # [2] ë°°í¬ ë° ì‹¤í–‰ ë‹¨ê³„ (ì´ ë¶€ë¶„ì´ ê°•ë ¥í•˜ê²Œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!)
      # ----------------------------------------------------------------
      - name: Run Docker Compose via WSL (With Auto-Fix)
        run: |
          Write-Host "ğŸ§¹ 1. Shutting down existing containers and removing orphans..."
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë‚´ë¦¬ê³ , ì—°ê²°ëœ ì»¨í…Œì´ë„ˆë“¤ë„ ì •ë¦¬í•©ë‹ˆë‹¤.
          wsl docker compose down --remove-orphans
          
          Write-Host "ğŸ§¹ 2. Pruning Docker System to fix 'mkdir file exists' error..."
          # [í•µì‹¬] ì‹œìŠ¤í…œ ì°Œêº¼ê¸°ë¥¼ ê°•ì œë¡œ ì§€ì›Œì„œ ê¼¬ì¸ ë§ˆìš´íŠ¸ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
          wsl docker system prune -f
          
          Write-Host "ğŸš€ 3. Building and starting containers..."
          # ê¹¨ë—í•œ ìƒíƒœì—ì„œ ë‹¤ì‹œ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
          wsl docker compose up -d --build
          
          Write-Host "âœ… Deployment Completed. Checking status..."
          Start-Sleep -Seconds 5
          wsl docker compose ps